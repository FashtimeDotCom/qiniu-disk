<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>七牛个人网盘</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="qwebchannel.js"></script>
    <script src="utils.js"></script>
    <link href="https://cdn.bootcss.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 14px;
            font-family: "Century Gothic", "Segoe UI", Arial, "Microsoft YaHei", Sans-Serif;
        }

        p {
            white-space: normal;
            word-break: break-all;
            line-height: 27px;
        }

        .div-content {
            margin-top: 50px;
            text-align: center;
        }

        .header-container {
            color: #fff;
            background-color: #5FC3E4;
            background-image: linear-gradient(120deg, #E55D87, #5FC3E4);
            padding: 10px 10px 10px 10px;
        }

        .bucket {
            overflow-x: auto;
            white-space: nowrap;
            margin: 15px 0 0 0;
            padding: 10px 0 8px 15px;
            background-color: rgb(44, 46, 69);
        }

        .bucket a {
            font-size: 15px;
            text-decoration: none;
            color: #999;
            padding: 1px 5px;
            cursor: pointer;
        }

        .bucket .active {
            font-weight: bold;
            color: #ddd;
            padding-bottom: 2px;
            border-bottom: 3px solid rgb(77, 111, 235);
        }

        .nav {
            margin: 10px;
            font-size: 14px;
        }

        .nav a {
            cursor: pointer;
        }

        .nav span {
            padding: 0 5px;
        }

        td {
            font-size: 14px;
            border-bottom: 1px solid lightgrey;
        }

        td a {
            cursor: pointer;
            text-decoration: none;
        }

        .btn {
            font-size: 12px;
        }

        .site-select-div {
            margin: 10px 0 0 10px;
            text-align: left;
        }

        .btn-loadmore {
            font-size: 12px;
            /*color: #1989fa;*/
            background-color: rgba(25, 137, 250, .04);
            border: 1px solid rgba(25, 137, 250, .4);
            border-radius: 20px;
            padding: 8px;
            cursor: pointer;
        }

        .btn-loadmore:hover {
            background-color: dodgerblue;
        }

        .footer-container {
            margin-top: 20px;
            padding: 15px;
            width: 100%;
            border-top: 1px solid #cccccc;
            background-color: #efefef;
        }

        .ft-span {
            margin: 15px;
            font-size: 14px;
        }

        .modal-body {
            color: #444;
        }


    </style>
</head>

<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="#">七牛个人网盘</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
        </ul>
        <form class="form-inline mt-2 mt-md-0">
            <button class="btn btn-dark my-2 my-sm-0" type="button" data-toggle="modal" data-target="#new-bucket-modal">
                新建bucket
            </button>
            <button class="btn btn-dark my-2 my-sm-0" type="button" data-toggle="modal" data-target="#setting-modal">
                设置
            </button>
        </form>
    </div>
</nav>
<div class="div-content">
    <div class="header-container bucket">
    </div>
    <div class="site-select-div">
        <span>域名选择:</span>
        <select class="site-select">
        </select>
    </div>
    <div class="nav">
        <a class="text-primary" onclick="enter_folder('')">全部文件</a>
        <span class="text-secondary"> > </span>
    </div>
    <div class="file-list-container">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>文件名</th>
                <th>大小</th>
                <th>最后更新</th>
                <th>操作</th>
            </tr>
            </thead>

            <tbody id="file-list">
            </tbody>
        </table>
        <a class="btn-loadmore text-primary" onclick="loadFile()">加载更多</a>
    </div>

    <div class="footer-container">
            <span class="ft-span">
                <a href="https://kyle.net.cn" target="_blank">©2018 https://kyle.net.cn All right reserved.</a>
            </span>
    </div>
</div>

<!-- Setting Modal -->
<div class="modal fade" id="setting-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">设置AccessKey和SecretKey</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="recipient-name" class="form-control-label">Access Key:</label>
                        <input type="text" class="form-control" id="access_key">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="form-control-label">Secret Key:</label>
                        <input type="text" class="form-control" id="secret_key">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="save_qiniu_keys()">保存</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="new-bucket-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建bucket</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="recipient-name" class="form-control-label">bucket名称:</label>
                        <input type="text" class="form-control" id="new-bucket"
                               placeholder="4~63个字符，可包含字母、数字、中划线。(注意不要重名)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="create_bucket()">保存</button>
            </div>
        </div>
    </div>
</div>
<script>
    var cur_bucket_name = "";
    var cur_bucket_marker = "";
    var cur_bucket_prefix = "";
    var cur_bucket_domain = "";

    //创建bucket
    function create_bucket() {
        var bucket_name = $('#new-bucket').val();
        if (bucket_name.length < 4 || bucket_name.length > 63) {
            alert("bucket名称必须为4~63个字符!");
            return;
        }

        var re = /^[0-9a-zA-Z\-]*$/g;
        if (!re.test(bucket_name)) {
            alert("bucket名称只能由字母、数字、中划线组成!");
            return;
        }

        //get files
        new QWebChannel(qt.webChannelTransport, function (channel) {
            channel.objects.handler.create_bucket(bucket_name, function (r) {
                $('#new-bucket-modal').modal('toggle');

                if (r === "True") {
                    alert("创建bucket成功!");
                    $(".bucket").html("");
                    //get buckets
                    new QWebChannel(qt.webChannelTransport, function (channel) {
                        channel.objects.handler.get_buckets(function (r) {
                            new_bucket_bar(r);
                        });
                    });
                } else {
                    if (r === '403') {
                        alert("新建存储空间失败，请先实名认证!");
                        return;
                    }
                    if (r === '614') {
                        alert("新建存储空间失败，bucket已经存在!");
                        return;
                    }
                    if (r === '400') {
                        alert("新建存储空间失败，bucket不符合命名规范!");
                        return;
                    }
                    if (r === '401') {
                        alert("新建存储空间失败，没有传入认证信息!");
                        return;
                    }
                    if (r === '630') {
                        alert("新建存储空间失败，创建bucket超过最大创建数(默认20个)!");
                        return;
                    }
                    alert("创建bucket失败，请检查AccessKey和SecretKey是否正确!");
                }
            });
        });

    }

    //切换bucket
    function change_bucket(bucket_name) {
        var a = $(".bucket");
        a.find('a').removeClass("active");

        for (var i in a.find('a')) {
            var bucket = a.find('a')[i];
            if (bucket.name === bucket_name) {
                bucket.className = 'active';

                cur_bucket_name = bucket_name;
                cur_bucket_marker = "";
                cur_bucket_prefix = "";
                $("#file-list").html("");
                init_bucket_domains(init_bucket_files);
                break;
            }
        }
    }

    function init_nav_dir() {
        var html_str = '<a class="text-primary" onclick="enter_folder(\'\')">全部文件</a>' +
            '<span class="text-secondary"> > </span>';
        if (cur_bucket_prefix.length > 0) {
            var folder_name = cur_bucket_prefix.slice(0, -1).split("/");
            var tmp_dir = "";
            for (var f in folder_name) {
                tmp_dir += folder_name[f] + "/";
                html_str += '<a class="text-primary" onclick="enter_folder(\'' + tmp_dir + '\')">' + folder_name[f] + '</a>';
                html_str += '<span class="text-secondary"> > </span>';
            }
        }

        $(".nav").html(html_str);
    }

    function enter_folder(name) {
        cur_bucket_marker = "";
        cur_bucket_prefix = name;
        $("#file-list").html("");
        init_bucket_files();
    }

    //bucket file html代码
    function bucket_file_html(name, size, timestamp) {
        var storagestr = "--";
        if (size > 0) {
            storagestr = get_human_storage(size);
        }
        var timestr = "--";
        if (timestamp > 0) {
            timestr = timestamp2timestr(timestamp / 10000000);
        }

        var file_url = "";
        var disabled_attr = "";
        var icon = "images/OtherType.png";
        if (size === 0 && timestamp === 0) {
            disabled_attr = 'disabled="disabled"';
            icon = 'images/FolderType.png';
            name = '<a onclick="enter_folder(\'' + cur_bucket_prefix + name + '\')" >' + name.slice(0, -1) + '</a>';
        } else {
            file_url = cur_bucket_prefix + name;
            //判断当前字符串是否以str结束
            if (typeof String.prototype.endsWithIgnoreCase !== 'function') {
                String.prototype.endsWithIgnoreCase = function (str) {
                    if (typeof(str) !== 'string' || str.length > this.length) {
                        return false;
                    }
                    return this.slice(-str.length).toLowerCase() === str.toLowerCase();
                };
            }

            if (name.endsWithIgnoreCase(".apk")) {
                icon = "images/ApkType.png";
            } else if (name.endsWithIgnoreCase(".doc")) {
                icon = "images/DocType.png";
            } else if (name.endsWithIgnoreCase(".exe")) {
                icon = "images/ExeType.png";
            } else if (name.endsWithIgnoreCase(".png") || name.endsWithIgnoreCase(".jpg") ||
                name.endsWithIgnoreCase(".jpeg") || name.endsWithIgnoreCase(".bmp")) {
                icon = "images/ImgType.png";
            } else if (name.endsWithIgnoreCase(".ppt")) {
                icon = "images/PptType.png";
            } else if (name.endsWithIgnoreCase(".xls") || name.endsWithIgnoreCase(".xlsx")) {
                icon = "images/XlsType.png";
            } else if (name.endsWithIgnoreCase(".pdf")) {
                icon = "images/PdfType.png";
            } else if (name.endsWithIgnoreCase(".rar") || name.endsWithIgnoreCase(".zip") ||
                name.endsWithIgnoreCase(".7z")) {
                icon = "images/RarType.png";
            } else if (name.endsWithIgnoreCase(".torrent")) {
                icon = "images/TorrentType.png";
            } else if (name.endsWithIgnoreCase(".txt")) {
                icon = "images/TxtType.png";
            } else if (name.endsWithIgnoreCase(".mp4") || name.endsWithIgnoreCase(".avi") ||
                name.endsWithIgnoreCase(".rmvb")) {
                icon = "images/VideoType.png";
            } else if (name.endsWithIgnoreCase(".ipa")) {
                icon = "images/IpaType.png";
            }
        }

        return '<tr>' +
            '<td class="text-left">' + '<img src="' + icon + '" />' + name + '</td>' +
            '<td>' + storagestr + '</td>' +
            '<td>' + timestr + '</td>' +
            '<td>' +
            '<button onclick="copy_url(\'' + file_url + '\')" type="button" class="btn btn-primary" ' + disabled_attr + '>复制链接</button>' + '\n' +
            '<button onclick="download_url(\'' + file_url + '\')" type="button" class="btn btn-primary" ' + disabled_attr + '>下载</button>' + '\n' +
            '<button onclick="" type="button" class="btn btn-danger" ' + disabled_attr + '>删除</button>' +
            '</td>' +
            '</tr>';
    }

    function copy_url(file) {
        if (file !== "") {
            alert("http://" + $(".site-select").val() + "/" + file)
        }
    }

    function download_url(file) {
        if (file !== "") {
            alert("http://" + $(".site-select").val() + "/" + file)
        }
    }


    function loadFile() {
        //get files
        new QWebChannel(qt.webChannelTransport, function (channel) {
            channel.objects.handler.get_files(cur_bucket_name, cur_bucket_marker, cur_bucket_prefix, function (r) {
                var obj = JSON.parse(r);
                var html_str = "";
                var item_count = 0;
                for (var d in obj.directories) {
                    html_str += bucket_file_html(obj.directories[d], 0, 0);
                    item_count += 1;
                }
                for (var f in obj.files) {
                    html_str += bucket_file_html(obj.files[f].name, obj.files[f].size, obj.files[f].timestamp);
                    item_count += 1;
                }

                if (html_str !== "") {
                    if (cur_bucket_marker !== "") {
                        $("#file-list").append(html_str);
                    } else {
                        $("#file-list").html(html_str);
                    }
                }

                if (item_count < 20) {
                    $(".btn-loadmore").text("没有了");
                    $(".btn-loadmore").removeAttr("onclick");
                }

                cur_bucket_marker = obj.marker;
            });
        });
    }

    //获取bucket域名列表
    function init_bucket_domains(lf) {
        new QWebChannel(qt.webChannelTransport, function (channel) {
            channel.objects.handler.get_bucket_domains(cur_bucket_name, function (r) {
                if (r === "") {
                    $(".site-select").html("");
                    alert("FAILED! 此bucket没有找到域名！");
                    return;
                }

                var domains = r.split(";");
                if (domains.length > 0) {
                    cur_bucket_domain = domains[0];
                } else {
                    $(".site-select").html("");
                    alert("FAILED! 此bucket没有找到域名！");
                    return;
                }

                var htmlstr = "";
                for (var i = 0, len = domains.length; i < len; i++) {
                    htmlstr += '<option>' + domains[i] + '</option>'
                }
                $(".site-select").html(htmlstr);
                lf();
            });
        });
    }

    //初始化bucket文件列表
    function init_bucket_files() {
        init_nav_dir();
        loadFile();
        $(".btn-loadmore").text("加载更多");
        $(".btn-loadmore").attr("onclick", "loadFile();");
    }

    function new_bucket_bar(r) {
        if (r === 'False') {
            alert("获取bucket失败，请检查AccessKey和SecretKey是否正确！");
            return;
        }
        if (r === "True") {
            alert("请创建新bucket！");
            return;
        }
        // 去掉True四个字母
        r = r.slice(4);

        var buckets = r.split(";");
        if (buckets.length > 0) {
            cur_bucket_name = buckets[0];
            init_bucket_domains(init_bucket_files);
        } else {
            alert("还没有仓库呢，快去创建一个仓库吧！");
            return;
        }
        for (var i = 0, len = buckets.length; i < len; i++) {
            var func_name = 'change_bucket("' + buckets[i] + '")';
            if (i === 0) {
                $(".bucket").append('<a name="' + buckets[i] + '" class="active" onclick=' + func_name + '>' + buckets[i] + '</a>');
            } else {
                $(".bucket").append('<a name="' + buckets[i] + '" onclick=' + func_name + '>' + buckets[i] + '</a>');
            }
        }
    }

    function show_setting_dialog() {
        $('#setting-modal').modal();
        return "show modal --by js."
    }

    function save_qiniu_keys() {
        var ak = $('#access_key').val();
        var sk = $('#secret_key').val();
        if (ak === "" || sk === "") {
            alert("AccessKey 和 SecretKey都不能为空哦！");
            return
        }

        new QWebChannel(qt.webChannelTransport, function (channel) {
            //save access_key and secret_key
            channel.objects.handler.save_keys(ak, sk, function (r) {
                console.log(r);
            });
            //get buckets
            channel.objects.handler.get_buckets(function (r) {
                new_bucket_bar(r);
            });
        });
        $('#setting-modal').modal('toggle');
    }

    function set_keys(ak, sk) {
        $('#access_key').val(ak);
        $('#secret_key').val(sk);

        //get buckets
        new QWebChannel(qt.webChannelTransport, function (channel) {
            channel.objects.handler.get_buckets(function (r) {
                new_bucket_bar(r);
            });
        });
    }

</script>
</body>

</html>
